<!DOCTYPE html>
<html lang="ca" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Botarell App - Despeses</title>
  
  <link rel="icon" type="image/jpeg" href="logo.jpg">
  <link rel="apple-touch-icon" href="logo.jpg">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* =========================================
       VARIABLES DE COLORS
       ========================================= */
    :root { 
      --bg-body: #0f172a;       
      --bg-card: #1e293b;       
      --text-main: #f1f5f9;     
      --text-muted: #94a3b8;    
      --primary: #fbbf24;       
      --primary-rgb: 251, 191, 36;
      --input-bg: #020617;      
      --border: #334155;        
      --success: #10b981; 
      --danger: #ef4444;
      --radius: 16px; 
      --radius-sm: 10px; 
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); 
    }

    [data-theme="light"] {
      --bg-body: #f1f5f9;       
      --bg-card: #ffffff;       
      --text-main: #0f172a;     
      --text-muted: #64748b;    
      --primary: #2563eb;       
      --primary-rgb: 37, 99, 235;
      --input-bg: #f8fafc;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background-color: var(--bg-body); 
      color: var(--text-main); 
      min-height: 100vh; 
      padding-bottom: 120px; 
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .app { max-width: 680px; margin: 0 auto; padding: 20px; position: relative; }
    
    /* HEADER */
    .header { text-align: center; margin-bottom: 30px; position: relative; }
    
    .theme-toggle-btn {
      position: absolute; top: 0; right: 0;
      background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main);
      width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
      box-shadow: var(--shadow); transition: all 0.2s ease;
    }
    .logo-container { margin-bottom: 20px; display: flex; justify-content: center; }
    .logo-img { max-width: 180px; height: auto; border-radius: 12px; filter: drop-shadow(0 0 10px rgba(var(--primary-rgb), 0.3)); }

    /* BOT√ì INSTAL¬∑LAR (ESTIL ESPECIAL) */
    .install-container { margin-top: 10px; display: flex; justify-content: center; }
    .btn-install {
      background: linear-gradient(45deg, var(--primary), #f59e0b);
      color: #0f172a; /* Sempre fosc per contrastar amb el daurat */
      border: none; padding: 8px 16px; border-radius: 20px;
      font-size: 14px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; gap: 8px;
      box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.4);
      transition: transform 0.2s;
      animation: pulse 2s infinite;
    }
    .btn-install:active { transform: scale(0.95); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* CARDS & INPUTS */
    .card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .card h3 { margin-bottom: 15px; font-size: 1.1rem; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    
    .input-group { margin-bottom: 16px; }
    .input-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; }
    input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 16px; background: var(--input-bg); color: var(--text-main); }
    input:focus, textarea:focus { border-color: var(--primary); outline: none; }
    
    /* BTNS */
    .btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border: none; border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: var(--bg-body); }
    [data-theme="light"] .btn-primary { color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-danger { background: var(--danger); color: white; }
    .hidden { display: none !important; }

    /* COMPONENTS */
    .participant-card { background: rgba(125,125,125,0.1); border-radius: var(--radius-sm); padding: 14px; margin-bottom: 10px; border: 1px solid var(--border); }
    .participant-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .expense-tag { background: var(--input-bg); border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; color: var(--text-main); }
    .remove { background: var(--text-muted); border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; color: var(--bg-card); display: flex; align-items: center; justify-content: center;}
    .add-expense-row { display: flex; gap: 8px; }
    .add-expense-btn { background: var(--success); color: white; border: none; padding: 0 14px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; }
    .meals-section { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .meals-control { display: flex; align-items: center; gap: 8px; background: var(--input-bg); padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
    .meals-btn { width: 28px; height: 28px; border: none; border-radius: 6px; background: var(--bg-card); color: var(--text-main); font-weight: bold; cursor: pointer; border: 1px solid var(--border); }
    .meals-value { font-weight: 700; font-size: 1.1rem; min-width: 24px; text-align: center; }
    
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; text-align: center; }
    .stat-box { background: rgba(125,125,125,0.1); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
    .stat-value { font-size: 1.1rem; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
    
    .balance-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border); }
    .positive { color: var(--success); font-weight: 700; }
    .negative { color: var(--danger); font-weight: 700; }
    .transfer-item { background: rgba(125,125,125,0.15); color: var(--text-main); padding: 14px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
    .transfer-amount { font-weight: 700; font-size: 1.1rem; color: var(--primary); }

    /* FOOTER & EXTRAS */
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); border-top: 1px solid var(--border); padding: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); display: grid; grid-template-columns: 1fr 1fr; gap: 10px; z-index: 1000; }
    .new-event-btn-container { position: fixed; bottom: 80px; left: 0; right: 0; padding: 0 20px; z-index: 900; pointer-events: none; }
    .btn-new-float { pointer-events: auto; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 100%; max-width: 680px; margin: 0 auto; }
    .btn-sync { background: transparent; color: var(--text-main); border: 1px solid var(--border); }
    .btn-save { background: var(--primary); color: var(--bg-body); font-weight: 800; font-size: 16px; } [data-theme="light"] .btn-save { color: white; }
    .unsaved-dot { display: inline-block; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; margin-left: 8px; }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: var(--bg-body); padding: 10px 20px; border-radius: 30px; font-size: 14px; z-index: 3000; opacity: 0; transition: opacity 0.3s; pointer-events: none; font-weight: bold; } [data-theme="light"] .toast { color: white; }
    .toast.show { opacity: 1; }
    .toast.success { background: var(--success); color: white; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .modal { background: var(--bg-card); padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; }
    .modal h3 { color: var(--primary); margin-bottom: 10px; }
    .modal p { color: var(--text-main); }

    /* HISTORY LIST */
    .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
    .history-info { flex: 1; }
    .history-name { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
    .history-date { font-size: 0.8rem; color: var(--text-muted); }
    .history-actions { display: flex; gap: 8px; }
    .btn-xs { padding: 6px 10px; font-size: 12px; }

  </style>
</head>
<body>

  <div id="toast" class="toast">Notificaci√≥</div>

  <div class="app">
    <header class="header">
      <button class="theme-toggle-btn" id="themeToggle" onclick="toggleTheme()" title="Canviar Tema">üåô</button>
      <div class="logo-container">
        <img src="logo.jpg" alt="Botarell App" class="logo-img" onerror="this.style.display='none'; document.getElementById('textLogo').style.display='block'">
      </div>
      <h1 id="textLogo" style="display:none; color:var(--primary);">BOTARELL APP</h1>
      <p id="appStatus" style="color: var(--text-muted);">Carregant...</p>

      <div class="install-container">
        <button id="btnInstall" class="btn-install hidden" onclick="installPWA()">
          üì≤ Instal¬∑lar App
        </button>
      </div>
    </header>

    <div id="step1" class="hidden">
      <div class="card">
        <h3>üéâ Nou Esdeveniment</h3>
        <p style="color: var(--text-muted); font-size:14px; margin-bottom:20px;">
          <strong>AV√çS:</strong> Crear un nou esdeveniment arxivar√† autom√†ticament l'actual a l'historial.
        </p>
        <div class="input-group"><label class="input-label">Nom</label><input type="text" id="eventNameInput" placeholder="Ex: Cal√ßotada"></div>
        <div class="input-group"><label class="input-label">Participants</label><textarea id="namesInput" rows="3" placeholder="Noms separats per comes..."></textarea></div>
        <button class="btn btn-primary" onclick="startNewEvent()">Comen√ßar</button>
      </div>
      
      <button class="btn btn-outline" style="margin-top: 20px;" onclick="showHistoryModal()">
        üìú Veure Historial
      </button>
    </div>

    <div id="step2" class="hidden">
      <div id="historyBanner" class="card hidden" style="background: var(--primary); border:none;">
        <h3 style="color: var(--bg-body); border:none; margin:0;">üëÅÔ∏è VISTA HIST√íRICA</h3>
        <p style="color: var(--bg-body); font-size: 12px; margin:0;">Est√†s veient un esdeveniment passat. No es pot editar.</p>
        <button class="btn" style="background: rgba(0,0,0,0.2); color:white; margin-top:10px; font-size:12px;" onclick="location.reload()">üîô Tornar a l'Actual</button>
      </div>

      <div class="card" style="border: 1px solid var(--primary);">
        <h2 id="currentEventTitle" style="color: var(--primary); font-size: 1.5rem;">...</h2>
        <div style="font-size: 11px; opacity: 0.6; margin-top: 5px; font-family: monospace; color: var(--text-muted);">ID: <span id="displayEventId">...</span></div>
      </div>

      <div class="card">
        <h3>üí∞ Despeses i √Äpats</h3>
        <div id="participantsList"></div>
        <div class="add-row" id="addRowSection"><input type="text" id="newParticipantName" placeholder="Nom nou participant..."><button class="btn btn-success" style="width: auto; padding: 0 20px;" onclick="addParticipant()">+ Afegir</button></div>
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-value" id="totalExpenses">0 ‚Ç¨</div><div class="stat-label">Total</div></div>
          <div class="stat-box"><div class="stat-value" id="totalMeals">0</div><div class="stat-label">√Äpats</div></div>
          <div class="stat-box"><div class="stat-value" id="costPerMeal">0 ‚Ç¨</div><div class="stat-label">Per cap</div></div>
        </div>
      </div>

      <div class="card">
        <h3>üìä Balan√ß</h3>
        <div id="balanceList"></div>
      </div>

      <div class="card">
        <h3>üí∏ Liquidaci√≥</h3>
        <div id="transfersList" style="margin-top:15px;"></div>
      </div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <button class="btn btn-success" style="background: #25D366; color: white;" onclick="copyWhatsApp()">üì± WhatsApp</button>
        <button class="btn btn-outline" style="color: var(--primary); border-color: var(--primary);" onclick="generatePDF()">üìÑ PDF M√≤bil</button>
      </div>
      <br><br>
    </div>

    <div id="createBtnContainer" class="new-event-btn-container hidden">
        <button class="btn btn-new-float" onclick="resetToCreate()">‚ûï Crear Nou / Arxivar Actual</button>
    </div>
  </div>

  <div id="bottomBar" class="bottom-bar hidden">
    <button class="btn btn-sync" onclick="loadFromCloud()">üîÑ Actualitzar</button>
    <button class="btn btn-save" onclick="saveToCloud()">üíæ GUARDAR <span id="unsavedDot" class="unsaved-dot hidden"></span></button>
  </div>

  <div id="historyModal" class="modal-overlay hidden" onclick="document.getElementById('historyModal').classList.add('hidden')">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>üìú Historial</h3>
      <div id="historyListContent" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
        <p style="color: var(--text-muted);">Carregant...</p>
      </div>
      <button class="btn btn-outline" onclick="document.getElementById('historyModal').classList.add('hidden')">Tancar</button>
    </div>
  </div>

  <script>
    // --- GESTI√ì INSTAL¬∑LACI√ì PWA ---
    let deferredPrompt;
    const installBtn = document.getElementById('btnInstall');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.classList.remove('hidden'); // Mostrar bot√≥ quan estigui llest
    });

    async function installPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') { console.log('Usuari accepta instal¬∑lar'); }
      deferredPrompt = null;
      installBtn.classList.add('hidden');
    }

    window.addEventListener('appinstalled', () => {
      installBtn.classList.add('hidden');
      showToast("App instal¬∑lada correctament!", "success");
    });

    // --- TEMES ---
    function toggleTheme() {
      const html = document.documentElement;
      const btn = document.getElementById('themeToggle');
      if (html.getAttribute('data-theme') === 'light') { html.setAttribute('data-theme', 'dark'); btn.textContent = 'üåô'; localStorage.setItem('theme', 'dark'); }
      else { html.setAttribute('data-theme', 'light'); btn.textContent = '‚òÄÔ∏è'; localStorage.setItem('theme', 'light'); }
    }
    (function initTheme() { const saved = localStorage.getItem('theme'); if (saved === 'light') { document.documentElement.setAttribute('data-theme', 'light'); document.getElementById('themeToggle').textContent = '‚òÄÔ∏è'; } })();

    // --- CONFIG ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyxoefuSAQ6iT8GxPvjJhjFfPKiUwRXXJ2o5baKnPYJBRxtVnljxdM6JI107JR-GU53ng/exec"; 
    
    // ESTAT LOCAL
    var state = { id: 'evt-default-botarell', name: '', participants: [], lastModified: null };
    var cachedHistory = [];
    var hasUnsavedChanges = false;
    var isHistoryMode = false; 

    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('themeToggle');
      if (document.documentElement.getAttribute('data-theme') === 'light') btn.textContent = '‚òÄÔ∏è';
      loadFromCloud();
    });

    // --- l√≤gica N√öVOL ---
    function loadFromCloud() {
      if(hasUnsavedChanges && !confirm("Tens canvis sense guardar. Continuar?")) return;
      document.getElementById('appStatus').textContent = "üîÑ Connectant...";
      
      fetch(API_URL + "?id=" + state.id).then(r => r.json()).then(resp => {
        cachedHistory = resp.history || [];
        if (resp.active && resp.active !== '{}') {
          var activeData = JSON.parse(resp.active);
          state.name = activeData.name || "Sense nom";
          state.participants = activeData.participants || [];
          showToast("‚úÖ Dades carregades!", "success");
          hasUnsavedChanges = false; updateUnsavedDot(); render();
          document.getElementById('step1').classList.add('hidden');
          document.getElementById('step2').classList.remove('hidden');
          document.getElementById('bottomBar').classList.remove('hidden');
          document.getElementById('createBtnContainer').classList.remove('hidden');
          document.getElementById('appStatus').textContent = "Actiu";
        } else {
          document.getElementById('step1').classList.remove('hidden');
          document.getElementById('step2').classList.add('hidden');
          document.getElementById('appStatus').textContent = "Nou";
        }
      }).catch(e => { console.error(e); showToast("‚ùå Error connexi√≥", "error"); document.getElementById('appStatus').textContent = "Offline"; });
    }

    function saveToCloud() {
      if (isHistoryMode) return alert("No pots guardar canvis en l'historial.");
      document.getElementById('appStatus').textContent = "üíæ Guardant...";
      const payload = { action: 'save', data: { name: state.name, participants: state.participants } };
      fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.text()).then(resp => {
        if(resp.includes("OK")) { showToast("‚úÖ Guardat!", "success"); hasUnsavedChanges = false; updateUnsavedDot(); document.getElementById('appStatus').textContent = "Guardat"; } 
        else { showToast("‚ö†Ô∏è Error al servidor", "error"); }
      });
    }

    function startNewEvent() {
      const name = document.getElementById('eventNameInput').value.trim();
      const namesRaw = document.getElementById('namesInput').value;
      if(!name || !namesRaw) return alert("Omple dades!");
      
      document.getElementById('appStatus').textContent = "üóÑÔ∏è Arxivant...";
      var newData = { name: name, participants: namesRaw.split(/[,\n]+/).map(n => n.trim()).filter(n => n).map(n => ({ name: n, expenses: [], meals: 0 })) };
      const payload = { action: 'archive', data: newData };
      
      fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.text()).then(resp => {
        if(resp.includes("OK")) {
          state.name = newData.name;
          state.participants = newData.participants;
          isHistoryMode = false;
          document.getElementById('step1').classList.add('hidden');
          document.getElementById('step2').classList.remove('hidden');
          document.getElementById('bottomBar').classList.remove('hidden');
          document.getElementById('createBtnContainer').classList.remove('hidden');
          render();
          showToast("‚úÖ Nou creat i anterior arxivat!", "success");
        } else { alert("Error creant esdeveniment."); }
      });
    }

    function showHistoryModal() {
      var container = document.getElementById('historyListContent'); container.innerHTML = '';
      if (cachedHistory.length === 0) { container.innerHTML = '<p style="color:var(--text-muted); padding:20px;">No hi ha historial.</p>'; } else {
        cachedHistory.forEach(h => {
          var date = new Date(h.date).toLocaleDateString();
          var div = document.createElement('div'); div.className = 'history-item';
          div.innerHTML = `<div class="history-info"><div class="history-name">${h.name}</div><div class="history-date">${date}</div></div><div class="history-actions"><button class="btn btn-outline btn-xs" onclick='loadHistoryView(${JSON.stringify(h.data)})'>üëÅÔ∏è</button><button class="btn btn-danger btn-xs" onclick="deleteHistoryItem('${h.id}')">üóëÔ∏è</button></div>`;
          container.appendChild(div);
        });
      }
      document.getElementById('historyModal').classList.remove('hidden');
    }

    function deleteHistoryItem(id) {
      if(!confirm("Segur que vols esborrar aquesta entrada per sempre?")) return;
      const payload = { action: 'delete_history', id: id };
      fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.text()).then(resp => {
        if(resp.includes("OK")) { cachedHistory = cachedHistory.filter(h => h.id !== id); showHistoryModal(); showToast("Esborrat correctament", "success"); } 
        else { alert("Error esborrant."); }
      });
    }

    function loadHistoryView(jsonString) {
      try {
        var data = JSON.parse(jsonString);
        state.name = data.name; state.participants = data.participants;
        isHistoryMode = true; 
        document.getElementById('historyModal').classList.add('hidden'); document.getElementById('step1').classList.add('hidden'); document.getElementById('step2').classList.remove('hidden');
        document.getElementById('bottomBar').classList.add('hidden'); document.getElementById('createBtnContainer').classList.add('hidden');
        document.getElementById('historyBanner').classList.remove('hidden'); document.getElementById('addRowSection').classList.add('hidden');
        render();
        document.querySelectorAll('.remove, .meals-btn, .delete-participant-btn').forEach(el => el.style.display = 'none');
        document.querySelectorAll('input').forEach(el => el.disabled = true);
      } catch(e) { alert("Error carregant dades."); }
    }

    function resetToCreate() {
        document.getElementById('step2').classList.add('hidden'); document.getElementById('bottomBar').classList.add('hidden');
        document.getElementById('createBtnContainer').classList.add('hidden'); document.getElementById('step1').classList.remove('hidden');
    }

    function markAsChanged() { if(!isHistoryMode) { hasUnsavedChanges = true; updateUnsavedDot(); } }
    function updateUnsavedDot() { const dot = document.getElementById('unsavedDot'); if(hasUnsavedChanges) dot.classList.remove('hidden'); else dot.classList.add('hidden'); }
    function showToast(msg, type = 'normal') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show ' + type; setTimeout(() => t.className = 'toast', 3000); }
    function formatMoney(n) { return n.toLocaleString('ca-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨'; }
    function addExpense(i) { if(isHistoryMode) return; const val = parseFloat(document.getElementById(`exp-${i}`).value.replace(',', '.')); if (val > 0) { state.participants[i].expenses.push(val); document.getElementById(`exp-${i}`).value=''; render(); markAsChanged(); } }
    function removeExpense(pi, ei) { if(isHistoryMode) return; state.participants[pi].expenses.splice(ei, 1); render(); markAsChanged(); }
    function updateMeals(i, c) { if(isHistoryMode) return; if (state.participants[i].meals + c >= 0) { state.participants[i].meals += c; render(); markAsChanged(); } }
    function addParticipant() { if(isHistoryMode) return; const n = document.getElementById('newParticipantName').value.trim(); if(n) { state.participants.push({name:n, expenses:[], meals:0}); document.getElementById('newParticipantName').value=''; render(); markAsChanged(); } }
    function removeParticipant(idx) { if(isHistoryMode) return; if(confirm("Eliminar?")) { state.participants.splice(idx,1); render(); markAsChanged(); } }

    function render() {
      document.getElementById('currentEventTitle').textContent = state.name; document.getElementById('displayEventId').textContent = "botarell-actiu";
      let totalExp = 0, totalMeals = 0; const list = document.getElementById('participantsList'); list.innerHTML = '';
      state.participants.forEach((p, i) => {
        const pTotal = p.expenses.reduce((a,b)=>a+b,0); totalExp+=pTotal; totalMeals+=p.meals;
        const initial = p.name.charAt(0).toUpperCase();
        let tags = p.expenses.map((e,ei)=>`<span class="expense-tag">${formatMoney(e)} <button class="remove" onclick="removeExpense(${i},${ei})">‚úï</button></span>`).join('');
        list.insertAdjacentHTML('beforeend', `<div class="participant-card"><div class="participant-header"><div style="display:flex; align-items:center; gap:10px;"><div style="width:32px; height:32px; background:var(--bg-body); color:var(--primary); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold;">${initial}</div><div><div style="font-weight:700;">${p.name}</div><div style="font-size:11px; color:var(--text-muted);">Pagat: ${formatMoney(pTotal)}</div></div></div><button class="delete-participant-btn" onclick="removeParticipant(${i})" style="border:none; background:none; color:var(--text-muted);">‚úï</button></div><div class="expenses-list">${tags}</div><div class="add-expense-row"><input type="text" id="exp-${i}" placeholder="Import..." onkeypress="if(event.key==='Enter') addExpense(${i})"><button class="add-expense-btn" onclick="addExpense(${i})">OK</button></div><div class="meals-section"><span style="font-size:11px; font-weight:700; color:var(--text-muted);">√ÄPATS</span><div class="meals-control"><button class="meals-btn" onclick="updateMeals(${i},-1)">‚àí</button><span class="meals-value">${p.meals}</span><button class="meals-btn" onclick="updateMeals(${i},1)">+</button></div></div></div>`);
      });
      const cpm = totalMeals > 0 ? totalExp/totalMeals : 0;
      document.getElementById('totalExpenses').textContent = formatMoney(totalExp); document.getElementById('totalMeals').textContent = totalMeals; document.getElementById('costPerMeal').textContent = formatMoney(cpm);
      const balList = document.getElementById('balanceList'); balList.innerHTML=''; const transList = document.getElementById('transfersList'); transList.innerHTML='';
      let bals = state.participants.map(p => ({name:p.name, diff: p.expenses.reduce((a,b)=>a+b,0) - (p.meals*cpm)}));
      bals.forEach(b => { balList.insertAdjacentHTML('beforeend', `<div class="balance-item"><span>${b.name}</span><span class="${b.diff>=0?'positive':'negative'}">${b.diff>=0?'+':''}${formatMoney(b.diff)}</span></div>`); });
      let creds = bals.filter(b=>b.diff>0.01).sort((a,b)=>b.diff-a.diff); let debts = bals.filter(b=>b.diff<-0.01).map(b=>({name:b.name, diff:Math.abs(b.diff)})).sort((a,b)=>b.diff-a.diff);
      let i=0, j=0, hasT=false;
      while(i<debts.length && j<creds.length){
        let amt = Math.min(debts[i].diff, creds[j].diff);
        if(amt>0.01) { hasT=true; transList.insertAdjacentHTML('beforeend', `<div class="transfer-item"><span>${debts[i].name} ‚ûî ${creds[j].name}</span><span class="transfer-amount">${formatMoney(amt)}</span></div>`); }
        debts[i].diff-=amt; creds[j].diff-=amt; if(debts[i].diff<0.01) i++; if(creds[j].diff<0.01) j++;
      }
      if(!hasT) transList.innerHTML='<div style="text-align:center; padding:10px; opacity:0.7;">Tot quadrat!</div>';
      if(isHistoryMode) { document.querySelectorAll('.remove, .add-expense-btn, .delete-participant-btn').forEach(el => el.style.display = 'none'); }
    }

    function copyWhatsApp() {
      let txt = `Botarell App - *${state.name.toUpperCase()}*\n`; const total = document.getElementById('totalExpenses').textContent;
      txt += `üí∞ Total despesa: ${total}\n\n`; txt += `üìâ *Despeses:*\n`;
      let hasExpenses = false; state.participants.forEach(p => { const paid = p.expenses.reduce((a,b)=>a+b,0); if(paid > 0) { txt += `   ${p.name}: ${formatMoney(paid)}\n`; hasExpenses = true; } });
      if(!hasExpenses) txt += `   (Cap)\n`;
      txt += `\nüç¥ *√Äpats:*\n`; state.participants.forEach(p => { txt += `   ${p.name}: ${p.meals}\n`; });
      const transItems = document.querySelectorAll('.transfer-item');
      if(transItems.length > 0) { txt += `\nüí∏ *Pagaments:*\n`; transItems.forEach(t => { const namesClean = t.querySelector('span:first-child').innerText.replace('‚ûî', 'a'); const amount = t.querySelector('.transfer-amount').innerText; txt += `   ${namesClean} : ${amount}\n`; }); } else { txt += "\n‚úÖ Tot quadrat!\n"; }
      if (navigator.share) { navigator.share({ title: state.name, text: txt }).then(()=>{}).catch(()=>{}); return; }
      const textarea = document.createElement("textarea"); textarea.value = txt; textarea.style.position = "fixed"; textarea.style.left = "-9999px"; document.body.appendChild(textarea); textarea.focus(); textarea.select(); try { document.execCommand('copy'); showToast("Copiat al portapapers!", "success"); } catch (err) {} document.body.removeChild(textarea);
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf; const totalExp = state.participants.reduce((sum, p) => sum + p.expenses.reduce((a,b)=>a+b,0), 0);
      const totalMeals = state.participants.reduce((sum, p) => sum + p.meals, 0); const cpm = totalMeals > 0 ? totalExp/totalMeals : 0;
      let bals = state.participants.map(p => ({name:p.name, diff: p.expenses.reduce((a,b)=>a+b,0) - (p.meals*cpm)}));
      let creds = bals.filter(b=>b.diff>0.01).length; let debts = bals.filter(b=>b.diff<-0.01).length;
      let estimatedTransfers = Math.max(1, Math.min(creds, debts) + 1); let contentHeight = 110 + (state.participants.length * 28) + (estimatedTransfers * 15); 
      const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: [80, contentHeight] });
      doc.setFillColor(15, 23, 42); doc.rect(0, 0, 80, 25, 'F'); doc.setTextColor(251, 191, 36); doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.text("BOTARELL APP", 40, 10, { align: "center" }); doc.setTextColor(255, 255, 255); doc.setFontSize(12); doc.setFont("helvetica", "normal"); let safeName = state.name.length > 20 ? state.name.substring(0, 18) + "..." : state.name; doc.text(safeName, 40, 18, { align: "center" });
      let y = 35; doc.setTextColor(0, 0, 0); doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("RESUM GENERAL", 5, y); y += 6; doc.setFont("helvetica", "normal"); doc.setFontSize(11); doc.text(`Total Despeses: ${formatMoney(totalExp)}`, 5, y); y += 5; doc.text(`Total √Äpats: ${totalMeals}`, 5, y); y += 5; doc.setFont("helvetica", "bold"); doc.text(`Preu mitj√† √†pat: ${formatMoney(cpm)}`, 5, y); doc.setFont("helvetica", "normal"); y += 8; doc.line(5, y, 75, y); y += 8;
      doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("PARTICIPANTS", 5, y); y += 8; doc.setFontSize(11); state.participants.forEach(p => { const paid = p.expenses.reduce((a,b)=>a+b,0); const diff = paid - (p.meals * cpm); doc.setFont("helvetica", "bold"); doc.text(p.name, 5, y); doc.setFont("helvetica", "normal"); doc.text(`Pagat: ${formatMoney(paid)}`, 75, y, { align: "right" }); y += 5; doc.text(`√Äpats: ${p.meals}`, 75, y, { align: "right" }); y += 5; if(diff >= 0) doc.setTextColor(16, 185, 129); else doc.setTextColor(239, 68, 68); doc.text(`Balan√ß: ${diff>=0?'+':''}${formatMoney(diff)}`, 75, y, { align: "right" }); doc.setTextColor(0,0,0); y += 8; });
      y += 2; doc.line(5, y, 75, y); y += 8; doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("LIQUIDACI√ì", 5, y); y += 8; let finalBals = state.participants.map(p => ({name:p.name, diff: p.expenses.reduce((a,b)=>a+b,0) - (p.meals*cpm)})); let finalCreds = finalBals.filter(b=>b.diff>0.01).sort((a,b)=>b.diff-a.diff); let finalDebts = finalBals.filter(b=>b.diff<-0.01).map(b=>({name:b.name, diff:Math.abs(b.diff)})).sort((a,b)=>b.diff-a.diff); let i=0, j=0, hasT=false; doc.setFontSize(11); doc.setFont("helvetica", "normal"); while(i<finalDebts.length && j<finalCreds.length){ let amt = Math.min(finalDebts[i].diff, finalCreds[j].diff); if(amt>0.01) { hasT = true; let textPagament = `${finalDebts[i].name} a ${finalCreds[j].name}`; doc.text(textPagament, 5, y); doc.setFont("helvetica", "bold"); doc.text(`${formatMoney(amt)}`, 75, y, { align: "right" }); doc.setFont("helvetica", "normal"); y += 7; } finalDebts[i].diff-=amt; finalCreds[j].diff-=amt; if(finalDebts[i].diff<0.01) i++; if(finalCreds[j].diff<0.01) j++; } if(!hasT) doc.text("Tot quadrat!", 40, y, {align:"center"}); y += 10; doc.setFontSize(9); doc.setTextColor(150,150,150); doc.text(`Generat: ${new Date().toLocaleDateString('ca-ES')}`, 40, y, { align: "center" }); doc.save(`botarell_app_${state.id}.pdf`);
    }
    
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
  </script>
</body>
</html>